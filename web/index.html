<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
      <meta name="description" content="Coffee Mini App v19.9">
  
  <!-- Cache control -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="version" content="19.9">
  
  <!-- Service Worker Cache Bust - Version 19.9 -->
  <!-- –ö–†–ò–¢–ò–ß–ù–û: –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ü–ï–†–í–´–ú –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è Service Workers –î–û –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
  <script>
    (function() {
      var EXPECTED_VERSION = '19.9';
      var VERSION_TIMESTAMP = Date.now();
      console.log('üöÄ Cache Bust Script v' + EXPECTED_VERSION + ' at ' + new Date().toISOString());
      
      // –®–ê–ì 1: –ù–ï–ú–ï–î–õ–ï–ù–ù–û –æ—Ç–∫–ª—é—á–∏—Ç—å –≤—Å–µ Service Workers –î–û –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          console.log('üî¥ Found ' + registrations.length + ' service workers - unregistering ALL');
          var unregisterPromises = registrations.map(function(registration) {
            return registration.unregister().then(function(success) {
              console.log('üî¥ Service Worker unregistered:', registration.scope, success);
              return success;
            }).catch(function(err) {
              console.error('üî¥ Error unregistering SW:', err);
              return false;
            });
          });
          Promise.all(unregisterPromises).then(function(results) {
            console.log('üî¥ All service workers unregistered:', results.every(r => r));
          });
        }).catch(function(err) {
          console.error('üî¥ Error getting service worker registrations:', err);
        });
      }
      
      // –®–ê–ì 2: –ù–ï–ú–ï–î–õ–ï–ù–ù–û –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∫–µ—à–∏
      if ('caches' in window) {
        caches.keys().then(function(names) {
          console.log('üî¥ Found ' + names.length + ' caches - deleting ALL');
          var deletePromises = names.map(function(name) {
            return caches.delete(name).then(function(success) {
              console.log('üî¥ Cache deleted:', name, success);
              return success;
            });
          });
          Promise.all(deletePromises).then(function(results) {
            console.log('üî¥ All caches deleted:', results.every(r => r));
          });
        });
      }
      
      // –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ main.dart.js —Å –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
      var versionCheckAttempts = 0;
      var maxAttempts = 15; // –£–≤–µ–ª–∏—á–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
      var lastCheckedVersion = sessionStorage.getItem('lastCheckedVersion');
      
      // –ï—Å–ª–∏ –≤–µ—Ä—Å–∏—è –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –∏–ª–∏ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∞—Å—å - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
      if (lastCheckedVersion && lastCheckedVersion !== EXPECTED_VERSION) {
        console.warn('‚ö†Ô∏è Stored version mismatch:', lastCheckedVersion, 'vs', EXPECTED_VERSION);
        sessionStorage.removeItem('lastCheckedVersion');
        sessionStorage.removeItem('versionChecked');
        sessionStorage.removeItem('forceReload');
        sessionStorage.removeItem('cacheCleared');
      }
      
      var checkVersion = setInterval(function() {
        versionCheckAttempts++;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ main.dart —á–µ—Ä–µ–∑ js.context)
        if (typeof window.DEPLOY_VERSION !== 'undefined') {
          clearInterval(checkVersion);
          var actualVersion = window.DEPLOY_VERSION;
          console.log('üì¶ Detected version in JS:', actualVersion, 'Expected:', EXPECTED_VERSION);
          
          sessionStorage.setItem('lastCheckedVersion', actualVersion);
          
          if (actualVersion !== EXPECTED_VERSION) {
            console.warn('‚ö†Ô∏è Version mismatch! Actual:', actualVersion, 'Expected:', EXPECTED_VERSION);
            console.warn('‚ö†Ô∏è Forcing full cache clear and reload...');
            
            // –ï—â–µ —Ä–∞–∑ –æ—á–∏—â–∞–µ–º –≤—Å–µ –∫–µ—à–∏
            if ('caches' in window) {
              caches.keys().then(function(names) {
                names.forEach(function(name) {
                  caches.delete(name);
                });
                // –û—Ç–∫–ª—é—á–∞–µ–º service workers –µ—â–µ —Ä–∞–∑
                if ('serviceWorker' in navigator) {
                  navigator.serviceWorker.getRegistrations().then(function(regs) {
                    regs.forEach(function(reg) {
                      reg.unregister();
                    });
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å –æ—á–∏—Å—Ç–∫–æ–π –∫–µ—à–∞
                    setTimeout(function() {
                      window.location.href = window.location.href.split('?')[0] + '?v=' + VERSION_TIMESTAMP;
                    }, 100);
                  });
                } else {
                  window.location.href = window.location.href.split('?')[0] + '?v=' + VERSION_TIMESTAMP;
                }
              });
            } else {
              window.location.href = window.location.href.split('?')[0] + '?v=' + VERSION_TIMESTAMP;
            }
            return;
          } else {
            console.log('‚úÖ Version check passed:', actualVersion);
            sessionStorage.setItem('versionChecked', EXPECTED_VERSION);
          }
        } else if (versionCheckAttempts >= maxAttempts) {
          clearInterval(checkVersion);
          console.warn('‚ö†Ô∏è Could not detect DEPLOY_VERSION after', maxAttempts, 'attempts');
          
          // –ï—Å–ª–∏ –≤–µ—Ä—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å –æ—á–∏—Å—Ç–∫–æ–π
          var forceReloadKey = 'forceReload_' + EXPECTED_VERSION;
          if (sessionStorage.getItem(forceReloadKey) !== 'done') {
            console.warn('‚ö†Ô∏è Force reload due to version detection failure');
            sessionStorage.setItem(forceReloadKey, 'done');
            
            // –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ–≥–æ
            Promise.all([
              'caches' in window ? caches.keys().then(function(names) {
                return Promise.all(names.map(function(name) {
                  return caches.delete(name);
                }));
              }) : Promise.resolve(),
              'serviceWorker' in navigator ? navigator.serviceWorker.getRegistrations().then(function(regs) {
                return Promise.all(regs.map(function(reg) {
                  return reg.unregister();
                }));
              }) : Promise.resolve()
            ]).then(function() {
              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –¥–ª—è –æ–±—Ö–æ–¥–∞ –∫–µ—à–∞
              window.location.href = window.location.href.split('?')[0] + '?v=' + VERSION_TIMESTAMP + '&force=true';
            });
          }
        }
      }, 500);
      // –®–ê–ì 4: –ü–µ—Ä–µ—Ö–≤–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏ main.dart.js —á–µ—Ä–µ–∑ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—é _flutter.buildConfig
      // –≠—Ç–æ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± —á–µ–º –ø–µ—Ä–µ—Ö–≤–∞—Ç createElement
      var originalFlutterConfig = window._flutter;
      Object.defineProperty(window, '_flutter', {
        get: function() {
          return originalFlutterConfig;
        },
        set: function(value) {
          originalFlutterConfig = value;
          // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º buildConfig –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏ –∫ main.dart.js
          if (value && value.buildConfig && value.buildConfig.builds) {
            value.buildConfig.builds.forEach(function(build) {
              if (build && build.mainJsPath && typeof build.mainJsPath === 'string') {
                if (build.mainJsPath.includes('main.dart.js') && !build.mainJsPath.includes('?v=')) {
                  build.mainJsPath = build.mainJsPath + '?v=' + EXPECTED_VERSION + '&t=' + VERSION_TIMESTAMP;
                  console.log('üîß Modified buildConfig mainJsPath:', build.mainJsPath);
                }
              }
            });
          }
        },
        configurable: true
      });
    })();
      // –®–ê–ì 4: –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ - –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —á–µ—Ä–µ–∑ MutationObserver
      // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º script —Ç–µ–≥–æ–≤ –∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –∏—Ö src
      var observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          mutation.addedNodes.forEach(function(node) {
            if (node.tagName === 'SCRIPT' && node.src) {
              var src = node.src;
              if (typeof src === 'string' && src.includes('main.dart.js') && !src.includes('?v=')) {
                var newSrc = src + '?v=' + EXPECTED_VERSION + '&t=' + VERSION_TIMESTAMP;
                console.log('üîß Detected main.dart.js, modifying:', src, '->', newSrc);
                node.src = newSrc;
              }
            }
          });
        });
      });
      
      // –ù–∞—á–∏–Ω–∞–µ–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ
      observer.observe(document.head, { childList: true, subtree: true });
      observer.observe(document.body, { childList: true, subtree: true });
    })();
  </script>
  
  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="fl_mini_app_v3">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>Coffee Mini App</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- Telegram Web App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <script>
    // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º _flutter.buildConfig –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π bootstrap –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏ –∫ main.dart.js
    (function() {
      var EXPECTED_VERSION = '19.9';
      var VERSION_TIMESTAMP = Date.now();
      
      // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É _flutter.buildConfig
      if (!window._flutter) {
        window._flutter = {};
      }
      
      var originalFlutter = window._flutter;
      Object.defineProperty(window, '_flutter', {
        get: function() {
          return originalFlutter;
        },
        set: function(value) {
          originalFlutter = value;
          if (value && value.buildConfig && value.buildConfig.builds) {
            value.buildConfig.builds.forEach(function(build) {
              if (build && build.mainJsPath && typeof build.mainJsPath === 'string') {
                if (build.mainJsPath.includes('main.dart.js') && !build.mainJsPath.includes('?v=')) {
                  build.mainJsPath = build.mainJsPath + '?v=' + EXPECTED_VERSION + '&t=' + VERSION_TIMESTAMP;
                  console.log('üîß Modified buildConfig mainJsPath:', build.mainJsPath);
                }
              }
            });
          }
        },
        configurable: true
      });
      
      // –¢–∞–∫–∂–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º buildConfig –µ—Å–ª–∏ –æ–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      if (originalFlutter && originalFlutter.buildConfig && originalFlutter.buildConfig.builds) {
        originalFlutter.buildConfig.builds.forEach(function(build) {
          if (build && build.mainJsPath && typeof build.mainJsPath === 'string') {
            if (build.mainJsPath.includes('main.dart.js') && !build.mainJsPath.includes('?v=')) {
              build.mainJsPath = build.mainJsPath + '?v=' + EXPECTED_VERSION + '&t=' + VERSION_TIMESTAMP;
              console.log('üîß Modified existing buildConfig mainJsPath:', build.mainJsPath);
            }
          }
        });
      }
    })();
  </script>
      <script src="flutter_bootstrap.js?v=19.8" async></script>
</body>
</html>
