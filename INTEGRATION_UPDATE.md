# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Flutter Mini App —Å Telegram Bot

## –î–∞—Ç–∞: 25.12.2024

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–¥–∞–ª –Ω–∞ —Å—Ç–∞—Ä—Ç–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (PermissionsScreen) –≤–º–µ—Å—Ç–æ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é, —Ö–æ—Ç—è –µ–≥–æ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –±—ã–ª–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

## –ü—Ä–∏—á–∏–Ω–∞
–í—ã–±—Ä–∞–Ω–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω—è–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –≤ **–ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ** Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –Ω–æ **–ù–ï —Å–æ—Ö—Ä–∞–Ω—è–ª–∞—Å—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Supabase**. Telegram –±–æ—Ç –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—ã—Ç–∞–ª—Å—è –ø–æ–ª—É—á–∏—Ç—å `preferredLocationId` –∏–∑ –ë–î, –Ω–æ –µ–≥–æ —Ç–∞–º –Ω–µ –±—ã–ª–æ.

## –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ `SupabaseService` (lib/services/supabase_service.dart)

```dart
/// –û–±–Ω–æ–≤–ª—è–µ—Ç preferredLocationId –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
/// –≠—Ç–æ –∫–ª—é—á–µ–≤–æ–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ª–æ–∫–∞—Ü–∏–∏ —Å –±–æ—Ç–æ–º
static Future<bool> updateUserPreferredLocation({
  required String userId,
  required String locationId,
}) async {
  try {
    print('üîÑ [updateUserPreferredLocation] Updating preferredLocationId for user: $userId');
    print('üîÑ [updateUserPreferredLocation] New locationId: $locationId');

    await client
        .from('User')
        .update({
          'preferredLocationId': locationId,
          'updatedAt': DateTime.now().toIso8601String(),
        })
        .eq('id', userId);

    print('‚úÖ [updateUserPreferredLocation] Successfully updated preferredLocationId');
    return true;
  } catch (e, stackTrace) {
    print('‚ùå [updateUserPreferredLocation] Error: $e');
    print('‚ùå [updateUserPreferredLocation] Stack: $stackTrace');
    return false;
  }
}
```

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** —Å—Ç—Ä–æ–∫–∞ 560-585

---

### 2. –û–±–Ω–æ–≤–ª–µ–Ω `LocationProvider` (lib/providers/location_provider.dart)

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ 1:** –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç SupabaseService
```dart
import '../services/supabase_service.dart';
```

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ 2:** –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `_userId` –∏ –º–µ—Ç–æ–¥ `setUserId`
```dart
String? _userId; // –î–æ–±–∞–≤–ª—è–µ–º userId –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –ë–î

/// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç userId –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –ë–î
void setUserId(String? userId) {
  _userId = userId;
  print('üìç LocationProvider: userId —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω = $userId');
}
```

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ 3:** –ú–µ—Ç–æ–¥ `selectLocation` —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
```dart
Future<void> selectLocation(Location location) async {
  _selectedLocation = location;
  notifyListeners();

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ª–æ–∫–∞—Ü–∏—é –ª–æ–∫–∞–ª—å–Ω–æ
  await _saveLastLocation(location.id);

  // –ù–û–í–û–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –±–æ—Ç–æ–º
  if (_userId != null) {
    print('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º preferredLocationId –≤ –ë–î...');
    final success = await SupabaseService.updateUserPreferredLocation(
      userId: _userId!,
      locationId: location.id,
    );
    if (success) {
      print('‚úÖ preferredLocationId —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î: ${location.id}');
    } else {
      print('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å preferredLocationId –≤ –ë–î');
    }
  } else {
    print('‚ö†Ô∏è userId –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î');
  }
}
```

---

### 3. –û–±–Ω–æ–≤–ª–µ–Ω `main.dart` (lib/main.dart)

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ 1:** –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º userId –≤ LocationProvider

–°—Ç—Ä–æ–∫–∞ 162-163:
```dart
// –ù–û–í–û–ï: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º userId –≤ LocationProvider –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –ë–î
locationProvider.setUserId(user['id'] as String);
```

–°—Ç—Ä–æ–∫–∞ 191-192 (–¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
```dart
// –ù–û–í–û–ï: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º userId –≤ LocationProvider –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
locationProvider.setUserId(testUser['id'] as String);
```

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ 2:** –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–∏ –∞–≤—Ç–æ–≤—ã–±–æ—Ä–µ –ª–æ–∫–∞—Ü–∏–∏

–°—Ç—Ä–æ–∫–∞ 359:
```dart
print('üíæ Location automatically saved to DB via LocationProvider.selectLocation()');
```

---

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
2. `main.dart` —Å–æ–∑–¥–∞–µ—Ç/–ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
3. `main.dart` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `userId` –≤ `LocationProvider`
4. –ë–æ—Ç –ø–µ—Ä–µ–¥–∞–µ—Ç `location_id` —á–µ—Ä–µ–∑ hash –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL
5. `main.dart` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –ª–æ–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ `locationProvider.selectLocation()`
6. `LocationProvider.selectLocation()` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `preferredLocationId` –í –ë–î ‚úÖ
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–¥–∞–µ—Ç —Å—Ä–∞–∑—É –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

### –í—Ç–æ—Ä–æ–π –∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –≤—Ö–æ–¥—ã:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
2. –ë–æ—Ç —á–∏—Ç–∞–µ—Ç `preferredLocationId` –∏–∑ –ë–î ‚úÖ
3. –ë–æ—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É —Å `location_id` –≤ hash –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
4. `main.dart` –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ª–æ–∫–∞—Ü–∏—é –∏–∑ hash –∏–ª–∏ –∏–∑ –ë–î
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **—Å—Ä–∞–∑—É –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é** –º–∏–Ω—É—è —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω ‚úÖ

### –†—É—á–Ω–æ–π –≤—ã–±–æ—Ä –ª–æ–∫–∞—Ü–∏–∏:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –ª–æ–∫–∞—Ü–∏—é –≤ `LocationSelectScreen`
2. `LocationSelectScreen._selectLocation()` –≤—ã–∑—ã–≤–∞–µ—Ç `locationProvider.selectLocation()`
3. `LocationProvider.selectLocation()` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î ‚úÖ
4. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –±–æ—Ç –∑–Ω–∞–µ—Ç —ç—Ç—É –ª–æ–∫–∞—Ü–∏—é

---

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ª–æ–∫–∞—Ü–∏–∏ (—É–∂–µ –±—ã–ª–∏, –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å):

1. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 0:** `location_id` –∏–∑ hash –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL (–æ—Ç –±–æ—Ç–∞)
2. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1:** `preferredLocationId` –∏–∑ –ë–î
3. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2:** –õ–æ–∫–∞—Ü–∏—è –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
4. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3:** –ü–µ—Ä–≤–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è

---

## –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–æ—Ç–æ–º

–ë–æ—Ç (test.tg_mini_app_v1/bot.py) —É–∂–µ –∏–º–µ–µ—Ç –ª–æ–≥–∏–∫—É —á—Ç–µ–Ω–∏—è `preferredLocationId`:

```python
def get_user_location_context(user_id: int) -> Optional[Dict]:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –ª–æ–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞"""
    # ...
    preferred_location_id = user_row.get("preferredLocationId")
    # ...
```

–¢–µ–ø–µ—Ä—å Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ **–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç** `preferredLocationId` –≤ –ë–î, –∞ –±–æ—Ç –µ–≥–æ **—á–∏—Ç–∞–µ—Ç**. –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞! ‚úÖ

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥
1. –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç –≤ Telegram
2. –ù–∞–∂–∞—Ç—å "üì¶ –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥"
3. –í—ã–±—Ä–∞—Ç—å –ª–æ–∫–∞—Ü–∏—é
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–ª –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î —á—Ç–æ `preferredLocationId` —Å–æ—Ö—Ä–∞–Ω–µ–Ω

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥
1. –ó–∞–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –°–Ω–æ–≤–∞ –Ω–∞–∂–∞—Ç—å "üì¶ –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥"
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å—Ä–∞–∑—É –ø–æ–ø–∞—Å—Ç—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –±–µ–∑ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ ‚úÖ

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –°–º–µ–Ω–∞ –ª–æ–∫–∞—Ü–∏–∏
1. –í –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Å–º–µ–Ω–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é
2. –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. –û—Ç–∫—Ä—ã—Ç—å —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î–æ–ª–∂–Ω–∞ –æ—Ç–∫—Ä—ã—Ç—å—Å—è –Ω–æ–≤–∞—è –≤—ã–±—Ä–∞–Ω–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è ‚úÖ

---

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:
1. `lib/services/supabase_service.dart` - –¥–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `updateUserPreferredLocation`
2. `lib/providers/location_provider.dart` - –¥–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ª–æ–∫–∞—Ü–∏–∏
3. `lib/main.dart` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ userId –≤ LocationProvider

## –§–∞–π–ª—ã –ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- `lib/screens/location_select_screen.dart` (—É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `locationProvider.selectLocation()`)
- Telegram –±–æ—Ç (—É–∂–µ —á–∏—Ç–∞–µ—Ç `preferredLocationId` –∏–∑ –ë–î)
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö Supabase (–ø–æ–ª–µ `preferredLocationId` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ User)

---

## –ò—Ç–æ–≥

‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é
‚úÖ –ö–æ–¥ —á–∏—Å—Ç—ã–π –∏ –ª–æ–≥–∏—á–Ω—ã–π
‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É Flutter –∏ –±–æ—Ç–æ–º —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–¥–∞–µ—Ç —Å—Ä–∞–∑—É –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
‚úÖ –ù–∏–∫–∞–∫–∏—Ö breaking changes - –≤—Å–µ –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ
